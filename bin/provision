#!/usr/bin/env bash

echo
if [[ "${BASH_SOURCE[0]}" == "provision" || "${BASH_SOURCE[0]}" == "./provision" ]]; then
  echo "$(tput setaf 124)Please run the provisioning script from the root of the ADRL repository.$(tput sgr0)"
  echo "$(tput setaf 124)From that root directory you can issue the command \"./bin/provision\".$(tput sgr0)"
  echo "$(tput setaf 124)Attempting to change into that directory....$(tput sgr0)"
  cd .. || exit 1
  echo "$(tput setaf 124)Successful directory change, continuing.$(tput sgr0)"
elif [[ "${BASH_SOURCE[0]}" != "bin/provision" && "${BASH_SOURCE[0]}" != "./bin/provision" ]]; then
  echo "$(tput setaf 124)Please run the provisioning script from the root of the ADRL repository.$(tput sgr0)"
  echo "$(tput setaf 124)From that root directory you can issue the command \"bin/provision\".$(tput sgr0)"
  echo
  exit 1
fi

if [[ "$1" != "local" &&
      "$1" != "vagrant" &&
      "$1" != "test" &&
      "$1" != "staging" &&
      "$1" != "production" ]]; then
  if [[ -z "$1" ]]; then
    echo "$(tput setaf 124)Script Input Error: No argument provided$(tput sgr0)"
  else
    echo "$(tput setaf 124)Bad argument:$(tput sgr0) $1"
  fi
  echo "Script Usage: bin/provision <local|vagrant|test|staging|production>"
  exit 1
fi

vsphere=false;
if [[ "$1" == "production" || "$1" == "staging" || "$1" == "test" ]]; then
  vsphere=true
fi
if [[ $vsphere == true ]]; then
  echo "$(tput setaf 124)Provisioning ADRL Hydra for vSphere: Envrionment $1.$(tput sgr0)"
fi

#
# Functions
#

mkpasswd() {
  if [[ ! -x $(which sha256sum 2>/dev/null) ]]; then
    SHASUM=gsha256sum
  else
    SHASUM=sha256sum
  fi
  openssl rand -base64 64 | "$SHASUM" | tr -d '\n\ -'
}

# Pretty-prints and runs a command, exiting when there's non-zero output
run_cmd() {
  local cmd
  cmd="$*"
  echo "$(tput bold)==> $*$(tput sgr0)"
  eval "$cmd"

  export EXIT_STATUS=$?

  if [ "$EXIT_STATUS" != "0" ]; then
    echo "$(tput setaf 124)Failed ($EXIT_STATUS):$(tput sgr0) $cmd"
  fi
}

# Write the configuration variables so Ansible can be re-run on failure
write_savepoint() {
  cat <<EOF
#!/bin/bash
export EMAIL='$EMAIL'
export GH_USER='$GH_USER'
export REMOTE_GROUP='$REMOTE_GROUP'
export REMOTE_USER='$REMOTE_USER'
export SECRET='$SECRET'
export SERVER='$SERVER'
EOF
}

write_hosts() {
  cat <<EOF
[default]
default ansible_ssh_port=22 ansible_ssh_host=$SERVER
EOF
}

# http://docs.ansible.com/ansible/faq.html#how-do-i-handle-python-pathing-not-having-a-python-2-x-in-usr-bin-python-on-a-remote-machine
write_hosts_local() {
  cat <<EOF
[default]
default ansible_python_interpreter=/usr/local/bin/python
EOF
}

write_conf() {
cat <<EOF
[defaults]
#private_key_file = $IDENTITY
host_key_checking = False
control_path = %(directory)s/%%h-%%r
inventory = $(pwd)/hosts

[ssh_connection]
scp_if_ssh=True
EOF
}

NOW="$(date "+%Y-%m-%d-%H%M%S")"
export NOW

# If they pass a config file from a previous try, source it and don't
# prompt them for new parameters
if [ -f "$2" ]; then
  # shellcheck source=/dev/null
  . "$2"
else
  #
  # Set variables
  #
  # These variables are stored in secrets.yml, so we can SSH and check
  # them if need be.
  #
  # FIXME: store them in Secret Server and fetch via the API at run-time
  SECRET="$(mkpasswd)"
  export SECRET

  ANSIBLE_CONFIG="$(pwd)/ansible.cfg"
  export ANSIBLE_CONFIG

  if [ $vsphere == true ]; then
    echo -n "Set REMOTE_USER For Ansible SSH Access [ansible]: "
    read -r REMOTE_USER
    REMOTE_USER=${REMOTE_USER:-"ansible"}
    REMOTE_GROUP="$REMOTE_USER"
  elif [[ "$1" == "local" ]]; then
    REMOTE_USER="$USER"
    REMOTE_GROUP=admin
  else
    REMOTE_USER=vagrant
    REMOTE_GROUP=vagrant
  fi
  echo "Setting REMOTE_USER to '$REMOTE_USER'"
  echo "Setting REMOTE_GROUP to '$REMOTE_GROUP'"
  export REMOTE_USER
  export REMOTE_GROUP

  SERVER=${SERVER:-"localhost"}
  if [[ $vsphere == true ]]; then
    echo -n "Set Remote SERVER (FQDN or IP): "
    read -r SERVER
  fi
  echo "Setting Remote SERVER to '$SERVER'"
  export SERVER

  if [[ $vsphere == true ]]; then
    EMAIL=adrl@library.ucsb.edu
  else
    EMAIL=$(git config --get user.email | tr -d '\n')
    echo -n "Enter your GitHub username (for fetching your public key): "
    read -r GH_USER
    echo "Setting GH_USER to '$GH_USER'"
    export GH_USER="https://github.com/$GH_USER.keys"
  fi

  echo "Setting ADRL EMAIL address to '$EMAIL'"
  export EMAIL

  write_savepoint > "$1$NOW.cfg"
  chmod 600 "$1$NOW.cfg"
  echo "Created Configuration Save Point in File $1$NOW.cfg"
fi

if [[ $vsphere == true ]]; then
  write_hosts > hosts
  echo "Created Ansible Hosts File: hosts"
  write_conf > ansible.cfg
  echo "Created Ansible Configuration File: ansible.cfg"
# sosi
  ANS_DEBUG="-vv"
  ANS_USER=" -u $REMOTE_USER"
  ANS_PASSFLG=" --ask-become-pass"
  ANS_VAULTFLG=" --ask-vault-pass"
  ANS_FLAGS=${ANS_DEBUG}${ANS_USER}${ANS_PASSFLG}${ANS_VAULTFLG}

  if [[ "$1" == "production" ]]; then
    run_cmd "ansible-playbook ansible/adrl.yml -vv -u $REMOTE_USER --ask-become-pass --ask-vault-pass -e @ansible/prod_vars.yml"
  elif [[ "$1" == "staging" ]]; then
    run_cmd "ansible-playbook ansible/adrl.yml -vv -u $REMOTE_USER --ask-become-pass --ask-vault-pass -e @ansible/stage_vars.yml"
  elif [[ "$1" == "test" ]]; then
    run_cmd "ansible-playbook ansible/adrl.yml ${ANS_FLAGS} -e @ansible/dev_vars.yml"
#    run_cmd "ansible-playbook ansible/adrl.yml -vv -u $REMOTE_USER --ask-become-pass --ask-vault-pass -e @ansible/dev_vars.yml"
  fi

  if [ "$EXIT_STATUS" == "0" ]; then
    rm -f $1*.cfg
    echo "Provisioning complete."
    echo
    echo "Run \`SERVER=$SERVER make prod\` to deploy with Capistrano."
  else
    echo "$(tput bold)==> Ansible Deployment Did Not Complete(tput sgr0)"
    echo "$(tput bold)==> Configuration saved to $1$NOW.cfg$(tput sgr0)"
    echo "Please correct then re-run with \"bin/provision $1 $1$NOW.cfg\", or delete it NOW."
  fi

elif [[ "$1" == "vagrant" ]]; then

  if [[ -e ".vagrant/machines/default/virtualbox/id" ]]; then
    run_cmd "vagrant provision"
  else
    run_cmd "vagrant up"
  fi

  if [ "$EXIT_STATUS" == "0" ]; then
    rm -f $1*.cfg
    echo "Provisioning complete."
    echo
    echo "Run \`make vagrant\` to deploy with Capistrano."
    echo
  else
    echo "$(tput bold)==> Configuration saved to $1$NOW.cfg$(tput sgr0)"
    echo 'Re-run with `bin/provison development'" $1$NOW.cfg"'`'", or delete it NOW."
  fi
elif [[ "$1" == "local" ]]; then
  write_hosts_local > hosts
  write_conf > ansible.cfg

  run_cmd "ansible-playbook provisioning/osx/adrl.yml -vv --connection=local --ask-vault-pass -e @ansible/dev_vars.yml"

  if [ "$EXIT_STATUS" == "0" ]; then
    rm -f $1-*.cfg
    echo "Provisioning complete."
    echo
    echo "1. Run \`tomcat/bin/catalina start\` to start Tomcat."
    echo "2. Run \`bundle exec rake db:migrate\`."
    echo "3. Run \`bin/rails server\` to start WEBrick."
  else
    echo "$(tput bold)==> Configuration saved to $1$NOW.cfg$(tput sgr0)"
    echo "Re-run with \`bin/provison local $1$NOW.cfg\`, or delete it NOW."
  fi
fi
