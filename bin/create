#!/usr/bin/env bash

SECRET="$(openssl rand 50 | shasum -a 512 | tr -d '\- \n')"
export SECRET="$SECRET"

if [ "$1" != "" ]; then
  echo "Setting RAILS_ENV to $1"
  export RAILS_ENV="$1"
fi

if [ "$PORT" == "" ]; then
  port=${PORT:-"2222"}
  if [ "$RAILS_ENV" == "production" ]; then
    echo -n "Use PORT (default '22'): "
    read -r port
    port=${port:-"22"}
  fi
  echo "Setting PORT to '$port'"
  export PORT="$port"
fi

if [ "$REMOTE_USER" == "" ]; then
  remote_user=${REMOTE_USER:-"vagrant"}
  if [ "$RAILS_ENV" == "production" ]; then
    echo -n "Set REMOTE_USER (default 'root'): "
    read -r remote_user
    remote_user=${remote_user:-"root"}
  fi
  echo "Setting REMOTE_USER to '$remote_user'"
  export REMOTE_USER="$remote_user"
fi

if [ "$SERVER" == "" ]; then
  server=${SERVER:-"127.0.0.1"}
  if [ "$RAILS_ENV" == "production" ]; then
    echo -n "Set SERVER: "
    read -r server
  fi
  echo "Setting SERVER to '$server'"
  export SERVER="$server"
fi

if [ "$PG_PASS" == "" ]; then
  echo -n "Set the primary PostgreSQL password: "
  read -r -s pg_pass
  export PG_PASS="$pg_pass"
fi

if [ "$H_PG_PASS" == "" ]; then
  echo
  echo -n "Set the PostgreSQL password for the Hydra user/db: "
  read -r -s h_pg_pass
  export H_PG_PASS="$h_pg_pass"
fi

if [ "$M_PG_PASS" == "" ]; then
  echo
  echo -n "Set the PostgreSQL password for the Marmotta user/db: "
  read -r -s m_pg_pass
  export M_PG_PASS="$m_pg_pass"
fi

if [ "$FEDORA_PASS" == "" ]; then
  echo
  echo -n "Set password for Fedora user: "
  read -r -s fedora_pass
  export FEDORA_PASS="$fedora_pass"
fi

if [ "$LDAP_PASS" == "" ]; then
  echo
  echo -n "Enter password for the LDAP server: "
  read -r -s ldap_pass
  export LDAP_PASS="$ldap_pass"
fi

if [ "$EZID_USER" == "" ]; then
  echo
  echo -n "Enter Ezid username: "
  read -r ezid_user
  echo "Setting EZID_USER to '$ezid_user'"
  export EZID_USER="$ezid_user"
fi

if [ "$EZID_PASS" == "" ]; then
  echo -n "Enter password for Ezid: "
  read -r -s ezid_pass
  export EZID_PASS="$ezid_pass"
  echo
fi

if [ "$RAILS_ENV" == "production" ]; then
  if [ "$EZID_SHOULDER" == "" ]; then
    echo -n "Enter shoulder for Ezid: "
    read -r ezid_shoulder
    echo "Setting EZID_SHOULDER to '$ezid_shoulder'"
    export EZID_SHOULDER="$ezid_shoulder"
    echo
  fi
fi

run_cmd() {
  local cmd
  cmd="$*"
  echo "$(tput bold)==> $*$(tput sgr0)"
  eval "$cmd"

  exit_code=$?

  if [ "$exit_code" != "0" ]; then
    echo "$(tput setaf 124)Failed ($exit_code):$(tput sgr0) $cmd"
    exit $exit_code
  fi
}

write_hosts() {
  cat <<EOF
[adrl-hosts]
alex2 ansible_ssh_port=$PORT ansible_ssh_host=$SERVER
EOF
  }

if [ "$RAILS_ENV" == "development" ]; then
  run_cmd "vagrant up"

  echo "Provisioning complete."
  echo 'Run `make vagrant` to deploy with Capistrano.'
  echo
  echo "After the first deploy, restart Tomcat:"
  echo "  ssh -i $(pwd)/.vagrant/machines/default/virtualbox/private_key -o UserKnownHostsFile=/dev/null -o IdentitiesOnly=yes -o StrictHostKeyChecking=no $REMOTE_USER@$SERVER -p $PORT 'sudo /usr/sbin/service tomcat restart'"

elif [ "$RAILS_ENV" == "production" ]; then
  write_hosts > provisioning/hosts
  run_cmd "ansible-playbook provisioning/adrl.yml -i provisioning/hosts"

  echo "Provisioning complete."
  echo
  echo "Add deploy@$SERVER:~/.ssh/id_rsa.pub to your repository's authorized keys."
  echo
  echo 'Run `make prod` to deploy with Capistrano.'
  echo
  echo "After the first deploy, restart Tomcat:"
  echo "  ssh -o UserKnownHostsFile=/dev/null -o IdentitiesOnly=yes -o StrictHostKeyChecking=no $REMOTE_USER@$SERVER -p $PORT 'sudo /usr/sbin/service tomcat restart'"
fi
